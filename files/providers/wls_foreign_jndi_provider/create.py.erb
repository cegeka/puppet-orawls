# check the domain else we need to skip this (done in wls_access.rb)
real_domain='<%= domain %>'


name                    = '<%= provider_name %>'
target                  = '<%= target %>'
targettype              = '<%= targettype %>'
initial_context_factory = '<%= initial_context_factory %>'
provider_properties     = '<%= provider_properties %>'
provider_url            = '<%= provider_url %>'
user                    = '<%= user %>'
password                = '<%= password %>'
links                   = String('<%= links.keys.join(",") %>').split(",")
local_jndi_names        = String('<%= links.to_a.flatten.collect{|e| e.is_a?(Hash) ? e['local_jndi_name'] : nil}.compact.join(",") %>').split(",")
remote_jndi_names       = String('<%= links.to_a.flatten.collect{|e| e.is_a?(Hash) ? e['remote_jndi_name'] : nil}.compact.join(",") %>').split(",")
number_of_links         = len(links)

edit()
startEdit()

try:

    cd('/')
    cmo.createForeignJNDIProvider(name)
    cd('/ForeignJNDIProviders/' + name)
    cmo.setName(name)

    if initial_context_factory:
        cmo.setInitialContextFactory(initial_context_factory)

    if provider_url:
        cmo.setProviderURL(provider_url)

    if user:
        cmo.setUser(user)

    if password:
        cmo.setPassword(password)

    for link_no in range(number_of_links):
        cd('/ForeignJNDIProviders/' + name)
        link_name        = links[link_no]
        remote_jndi_name = remote_jndi_names[link_no]
        local_jndi_name  = local_jndi_names[link_no]
        print "setting remote_jndi_name to " + remote_jndi_name + " and local_jndi_name to " + local_jndi_name + " on link " + link_name
        cmo.createForeignJNDILink(link_name)
        cd('/ForeignJNDIProviders/' + name +'/ForeignJNDILinks/' + link_name)
        cmo.setLocalJNDIName(local_jndi_name)
        cmo.setRemoteJNDIName(remote_jndi_name)

    print "target: "     +  target
    print "targettype: " +  targettype

    targets     = String(target).split(",")
    targettypes = String(targettype).split(",")
    targetList  = []

    cd('/ForeignJNDIProviders/' + name)
    for i in range(len(targets)):
        print "target "+targets[i] + " " + targettypes[i]
        targetList.append( ObjectName('com.bea:Name=' + targets[i] + ',Type='+targettypes[i]) )
    set('Targets',jarray.array(targetList, ObjectName))

    if provider_properties:
        cd('/ForeignJNDIProviders/' + name)
        properties=provider_properties.split(",")
        new_properties = Properties()
        for property in properties:
            propname, val = property.split("=")
            new_properties.setProperty(propname, val)
        cmo.setProperties(new_properties)

    save()
    activate()
    print "~~~~COMMAND SUCCESFULL~~~~"

except:
    print "Unexpected error:", sys.exc_info()[0]
    undo('true','y')
    stopEdit('y')
    print "~~~~COMMAND FAILED~~~~"
    raise

